<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>marks</title>
    <link rel="stylesheet" href="/static/main.style.css">
    <link rel="stylesheet" href="/static/class.style.css">
    <link rel="stylesheet"
          href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:opsz,wght,FILL,GRAD@20..48,100..700,0..1,-50..200"/>
    <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:opsz,wght,FILL,GRAD@20..48,100..700,0..1,-50..200" />
</head>
<body>
<div>
    <label for="przedmioty_id">przedmioty</label><select id="przedmioty_id" class="under"></select>
    <label for="klasa_id">klasy</label><select id="klasa_id"></select>
    <button id="addMark" onclick="findStudents()">wybierz uczniow</button>
</div>
<div class="sectionAdd" id="mark_id"></div>
<div class="flex-container" id="notes_id"></div>
<div class="sectionAdd" id="done_id"></div>
<div class="flex-container" id="gradesDeleteId">
    <table id="table_id"></table>

</div>
</body>
<script>
    function createSelectWithDegreToChoose() {
        const parent = document.getElementById("mark_id");
        const select = document.createElement('select');
        for (const i of ['1', '1', '-2', '2', '2+', '-3', '3', '3+', '-4', '4', '4+', '-5', '5', '5+', '-6', '6']) {
            const option = document.createElement("option");
            option.innerHTML = i;
            select.appendChild(option);
            parent.appendChild(select);
        }

    }

    async function sendData(id,notes,row) {
        const mark = document.getElementById("mark_id");
        const subject = document.getElementById("przedmioty_id").value;
        const data = {id:id,mark: mark.childNodes[0].value, notes:notes.childNodes[1].value, subject:subject}
         await fetch('/degre/addDegre', {method:'POST', body:JSON.stringify(data),  headers: {'Content-Type': 'application/json'}});
        row.cells[3].innerHTML += `,${mark.childNodes[0].value}`;



    }

    async function addDegre(id,row) {
       createSelectWithDegreToChoose();
        const notes = document.getElementById("notes_id");
       const notesChild = document.createElement("textarea");
       notes.appendChild(notesChild);
        const butonDone = document.createElement("button");
        butonDone.innerHTML='<span class="material-symbols-outlined button">done</span>';
        const parentDone = document.getElementById("done_id");
        parentDone.appendChild(butonDone);
        butonDone.onclick=async ()=>
           await sendData(id,notes,row)
    }

    async function removeSelectGrade(select) {
        const degreId = select.selectedOptions[0].value;
        await fetch(`/degre/degreForDelete/${degreId}`, {method: 'DELETE'});
    }

    async function removeDegre(row,remove,add,subject, student_id) {
        const degreWithThisSubjectForThisStudent = await(await fetch(`/degre/degreWithThisSubjectForThisStudent/${subject}/${student_id}`)).json();
        remove.style.display='none';
        add.style.display='none';
        const done = document.createElement('button');
        done.innerHTML='<span class="material-symbols-outlined button">done</span>';
        row.cells[4].appendChild(done)
        const select = document.createElement('select');
        const selectParent = document.getElementById('gradesDeleteId');
        for(const i of degreWithThisSubjectForThisStudent){
            const option = document.createElement("option");
            option.innerHTML = i.mark;
            option.value= i.id;
            select.appendChild(option);
            selectParent.appendChild(select);
        }

        done.onclick=async()=>{
            remove.style.display='inline';
            add.style.display='inline';
            done.style.display='none';
            cancel.style.display='none';
            await removeSelectGrade(select);
            select.remove();
        }
        const cancel = document.createElement('button');
        cancel.innerHTML = '<span class="material-symbols-outlined button">close</span>';
        row.cells[4].appendChild(cancel);
        cancel.onclick=()=>{
            select.remove();
            done.style.display='none';
            cancel.style.display='none';
            remove.style.display='inline';
            add.style.display='inline';

        }
    }

    async function findStudents() {
        document.getElementById("table_id").innerHTML = '';
         const id = document.getElementById("klasa_id").value;
        const students = await (await fetch(`/listStudentInThisClass/${id}`)).json();
        const table = document.getElementById("table_id");
        const hRow = table.createTHead().insertRow();
        for (const i of ['lp', 'imie', 'nazwisko', 'oceny', 'akcja']) {
            hRow.insertCell().innerHTML = i;
        }
        let lp = 1
        for (const j of students) {
            const row = table.insertRow();
            row.insertCell().innerHTML = `${lp++}`;
            row.insertCell().innerHTML = j.name;
            row.insertCell().innerHTML = j.last_name;
            row.insertCell().innerHTML;
            row.insertCell().innerHTML;
            const add = document.createElement("button");
            add.innerHTML = '<span class="material-symbols-outlined button">add</span>';
            add.onclick = async () => await addDegre(j.id, row);
            row.cells[4].appendChild(add);
            const subject = document.getElementById("przedmioty_id").value;
            const degreWithThisSubjectForThisStudent = await(await fetch(`/degre/degreWithThisSubjectForThisStudent/${subject}/${j.id}`)).json();
            let listDegre = []
            for(const i of degreWithThisSubjectForThisStudent){
                listDegre.push(i.mark);
            }
            row.cells[3].innerHTML=listDegre;
            const buttonRemove = document.createElement("button");
            buttonRemove.innerHTML='<span class="material-symbols-outlined button">remove</span>';
            row.cells[4].appendChild(buttonRemove);
            buttonRemove.onclick= ()=> removeDegre(row,buttonRemove,add,subject,j.id)

        }
    }

    async function selectOfSubjects() {
        const subjects = await (await fetch('/getAllSubjects')).json();
        const select = document.getElementById("przedmioty_id");
        for (const i of subjects) {
            const selectChild = document.createElement("option");
            selectChild.value = i.name;
            selectChild.innerHTML = i.name;
            select.appendChild(selectChild);
        }
    }

    async function selectOfClasses() {
        const subjects = await (await fetch('/getAllClasses')).json();
        const select = document.getElementById("klasa_id");
        for (const i of subjects) {
            const selectChild = document.createElement("option");
            selectChild.value = i.id;
            selectChild.innerHTML = i.name;
            select.appendChild(selectChild);
        }
    }

    async function get_all() {
        await selectOfSubjects();
        await selectOfClasses();
    }

    get_all();


</script>
</html>