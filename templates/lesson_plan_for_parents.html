<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Plan lekcji - rodzic</title>
    <script src="/static/menu.js"></script>
    <link rel="stylesheet" href="/static/main.style.css">
    <link rel="stylesheet" href="/static/class.style.css">
    <link rel="stylesheet"
          href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:opsz,wght,FILL,GRAD@20..48,100..700,0..1,-50..200"/>
</head>
<body>
<div id="menu_id" class="menu"></div>
<script> createMenu(document.getElementById('menu_id'));</script>
<div>

    <label for="children_id">wybierz dziecko </label>
    <select id="children_id" onchange="createLessonPlanTableWithAttendance()"></select>
</div>
<div id="name_parents"></div>
<div>
    <label for="date_id">Date</label>
    <input id="date_id" type="month" name="date" onchange="createLessonPlanTableWithAttendance()">
</div>

<table id="calendar_id"></table>

</body>
<script>
    async function createParentsName(parent_id){
        const dataParent = await(await fetch(`/parents/getParent/${parent_id}`)).json();
        const parent = document.getElementById("name_parents");
        parent.innerHTML = `jesteś zalogowany jako rodzic: ${dataParent.name} ${dataParent.last_name}`;
    }
    async function createSelectOfChildrenForParent() {
        const parent_id = 5;
        const childrenOfParent = await (await fetch(`/student/get_all_children_for_parent/${parent_id}`)).json();
        const selectOfChildren = document.getElementById("children_id");
        for (const i of childrenOfParent) {
            const option = document.createElement("option");
            option.value = i.id;
            option.innerHTML = `${i.name} ${i.last_name}`
            option.selected=true;
            selectOfChildren.appendChild(option);
        }
    await createParentsName(parent_id);
    }



    async function createLessonPlanTableWithAttendance() {
        const attendance = await getAttendance();
        const summary = await fillTable(attendance)
        displaySummary(summary);

        function displaySummary(summary) {

        }

        async function fillTable(attendance) {
            createThRow();
            const allRows = await createTable();
            fillData(attendance, allRows);
            return undefined;

            function createThRow() {
                const table = document.getElementById("calendar_id");
                table.innerHTML = '';
                const hRow = table.createTHead().insertRow();
                for (const i of ['', 'poniedziałek', 'wtorek', 'środa', 'czwartek', 'piątek', 'sobota', 'niedziela']) {
                    hRow.insertCell().innerHTML = i;
                }
            }

            function findRow(h, allRows) {
                return allRows[h];
            }

            function findDay(key, date) {
                return new Date(`${date}-${key}`).getDay()
            }

            async function createTable() {
                const hours = await (await fetch('/configuration_hours/getAllTime')).json();
                const thTable = document.getElementById("calendar_id");
                const rowsToFind = {}
                for (const i of hours) {
                    const row = thTable.insertRow();
                    row.insertCell();
                    row.insertCell();
                    row.insertCell();
                    row.insertCell();
                    row.insertCell();
                    row.insertCell();
                    row.insertCell();
                    row.insertCell();
                    row.cells[0].innerHTML = `${i.from_hour} - ${i.until_hours}`;
                    row.cells[0].id = i.lp;
                    rowsToFind[i.from_hour] = i.lp;
                }
                return rowsToFind;
            }

            function fillData(attendance, allRow) {
                const date = document.getElementById("date_id").value;
                const table = document.getElementById("calendar_id");
                for (const [key, value] of Object.entries(attendance)) {
                    const numberDay = key;
                    for (const j of value) {
                        const row = findRow(j.h, allRow);
                        const cell = findDay(numberDay, date);
                        table.rows[row].cells[cell].innerHTML += `<span><div>${numberDay} ${j["sub"]} ${j["att"]}</div></span>`

                    }
                }
            }
        }


        async function getAttendance() {
            const student_id = document.getElementById("children_id").value;
            const date = document.getElementById("date_id").value;
            return await (await fetch(`/attendance/getAttendanceWithDateAndStudent/${date}/${student_id}`)).json();
        }
    }
    async function init()
    {
        document.getElementById('date_id').valueAsDate = new Date();
        await createSelectOfChildrenForParent();
        await createLessonPlanTableWithAttendance();
    }
    init();
</script>

</html>