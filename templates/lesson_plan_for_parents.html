<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Plan lekcji - rodzic</title>
    <script src="/static/menu.js"></script>
    <link rel="stylesheet" href="/static/main.style.css">
    <link rel="stylesheet" href="/static/class.style.css">
    <link rel="stylesheet"
          href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:opsz,wght,FILL,GRAD@20..48,100..700,0..1,-50..200"/>
</head>
<body>
<div id="menu_id" class="menu"></div>
<script> createMenu(document.getElementById('menu_id'));</script>
<div id="name_parents" class="separated"></div>
<div id="log_out" class="separated">
    <button>wyloguj</button>
</div>
<div>

    <label for="children_id">wybierz dziecko </label>
    <select id="children_id" onchange="createLessonPlanTableWithAttendance()"></select>
</div>
<div>
    <label for="date_id">Date</label>
    <input id="date_id" type="month" name="date" onchange="createLessonPlanTableWithAttendance()">
</div>
<div class="buttonAnditeminDiv">
    <div id="excuseId">
        <button id="selectAll" onclick="selectAll()" style="display: none">zaznacz wszystko</button>
        <button id="buttonSendId" style="display: none" onclick="sendDaysOfExcuse()">wyślij</button>
        <ul id="divId" style="display: none"></ul>
    </div>
    <button id="buttonExcuseId" title="usprawiedliw nieobecności dziecka" style="display: none">usprawiedliw</button>
    <table id="calendar_id"></table>
</div>
</body>
<script>
    async function createParentsName(parent_id) {
        const dataParent = await (await fetch(`/parents/getParent/${parent_id}`)).json();
        const parent = document.getElementById("name_parents");
        parent.innerHTML = `jesteś zalogowany jako rodzic: ${dataParent.name} ${dataParent.last_name}`;
    }

    async function createSelectOfChildrenForParent() {
        const parent_id = 5;
        const childrenOfParent = await (await fetch(`/student/get_all_children_for_parent/${parent_id}`)).json();
        const selectOfChildren = document.getElementById("children_id");
        for (const i of childrenOfParent) {
            const option = document.createElement("option");
            option.value = i.id;
            option.innerHTML = `${i.name} ${i.last_name}`
            option.selected = true;
            selectOfChildren.appendChild(option);
        }
        await createParentsName(parent_id);
    }


    async function createLessonPlanTableWithAttendance() {
        const attendance = await getAttendance();
        checkButtonExcuse(attendance);

        const summary = await fillTable(attendance)
        displaySummary(summary);

        function displaySummary(summary) {
            console.log(summary);
        }
        function checkButtonExcuse(j, attendance, date) {
                    const buttonExcuse = document.getElementById("buttonExcuseId");
                    if (j["att"] === "NB") {
                        buttonExcuse.style.display = 'inline';
                        buttonExcuse.onclick = () => createSelectWithNoPresents(attendance, date, buttonExcuse);
                    }
                }

        async function fillTable(attendance) {
            createThRow();
            const allRows = await createTable();
            await fillData(attendance, allRows);
            const studentId = document.getElementById("children_id").value;
            return await (await fetch(`/attendance/summary/${studentId}`)).json()

            function createThRow() {
                const table = document.getElementById("calendar_id");
                table.innerHTML = '';
                const hRow = table.createTHead().insertRow();

                for (const i of ['', 'poniedziałek', 'wtorek', 'środa', 'czwartek', 'piątek', 'sobota', 'niedziela']) {
                    hRow.insertCell().innerHTML = i;
                }
            }

            function findRow(h, allRows) {
                return allRows[h];
            }

            function findDay(key, date) {
                return new Date(`${date}-${key}`).getDay()
            }

            async function createTable() {
                const hours = await (await fetch('/configuration_hours/getAllTime')).json();
                const thTable = document.getElementById("calendar_id");
                const rowsToFind = {}
                for (const i of hours) {
                    const row = thTable.insertRow();
                    row.insertCell();
                    row.insertCell();
                    row.insertCell();
                    row.insertCell();
                    row.insertCell();
                    row.insertCell();
                    row.insertCell();
                    row.insertCell();
                    row.cells[0].innerHTML = `${i.from_hour} - ${i.until_hours}`;
                    row.cells[0].id = i.lp;
                    rowsToFind[i.from_hour] = i.lp;
                }
                return rowsToFind;
            }

            async function fillData(attendance, allRow) {
                const date = document.getElementById("date_id").value;
                const table = document.getElementById("calendar_id");

                for (const [key, value] of Object.entries(attendance)) {
                    const numberDay = key;
                    for (const j of value) {
                        const row = findRow(j.h, allRow);
                        const cell = findDay(numberDay, date);
                        const day = numberDay <= 9 ? '0' + numberDay : numberDay;
                        table.rows[row].cells[cell].innerHTML += `<div id="${numberDay} ${j["sub"]} ${j["att"]} ${j.h}"><div> ${j["sub"]} ${j["att"]}</div>
                        <div style="=text-align: right; font-size: 10px">${date}-${day}</div></div>`
                        colouringAttendance(table, j, row, cell, numberDay);
                        // await excuseForAbsence(j, table, row, cell, date, numberDay);

                    }

                }



                function createSelectWithNoPresents(attendance, date, bExcuse) {
                    const ul = document.getElementById("divId");
                    const child = document.getElementById("children_id").value;
                    ul.style.display = 'inline';
                    let stan = 0
                    for (const [key, value] of Object.entries(attendance)) {
                        for (const i of value) {
                            if (i["att"] === "NB") {
                                const li = document.createElement("li");
                                const option = document.createElement("input");
                                option.type = "checkbox";
                                option.onclick = () => disabled(option);
                                li.innerHTML = `${date}-${key <= 9 ? '0' + key : key} godzina ${i.h}- ${i["sub"]}`;
                                li.id = `${child}+${date}-${key <= 9 ? '0' + key : key}+${i["sub"]}`;
                                li.appendChild(option);
                                ul.appendChild(li);
                            }

                        }

                        function disabled(option) {
                            if (option.checked) {
                                stan += 1
                            } else {
                                stan -= 1
                            }

                            if (stan) {
                                document.getElementById("buttonSendId").disabled = false;
                            } else {
                                document.getElementById("buttonSendId").disabled = 'disabled';
                            }
                        }
                    }
                    bExcuse.style.display = 'none';
                    document.getElementById("selectAll").style.display = 'inline';
                    document.getElementById("buttonSendId").style.display = 'inline';
                    document.getElementById("buttonSendId").disabled = 'disabled';


                }

                function colouringAttendance(table, j, row, cell, numberDay) {

                    const id = document.getElementById(`${numberDay} ${j["sub"]} ${j["att"]} ${j.h}`)
                    if (j["att"] === "NB") {
                        id.classList.add("wrongInputData");

                    }
                    if (j["att"] === "SP") {
                        id.classList.add("midInputData");
                    } else {
                        id.classList.add("okInputData");
                    }
                }

                // async function excuseForAbsence(j, table, row, cell, date, day) {
                //     day = day <= 9 ? `${0}${day}` : day;
                //     if (j["att"] === "NB") {
                //         const datar = {
                //             "student_id": j.student_id,
                //             "attendance": 1,
                //             "hour": j.h,
                //             "day": `${date}-${day}`
                //         }
                // const buttonExcuseForAbsence = document.createElement("button");
                // buttonExcuseForAbsence.innerHTML = `<span class="button" title="usprawiedliw ${date}-${day}">usp</span>`;
                // table.rows[row].cells[cell].appendChild(buttonExcuseForAbsence);
                // buttonExcuseForAbsence.onclick = async () => {
                //     await fetch('/attendance/updateData', {
                //         method: 'PUT', body: JSON.stringify(datar),
                //         headers: {'Content-Type': 'application/json'}
                //     });
                //     await createLessonPlanTableWithAttendance();

                // }
                //     }
                // }
            }
        }

        async function getAttendance() {
            const student_id = document.getElementById("children_id").value;
            const date = document.getElementById("date_id").value;
            return await (await fetch(`/attendance/getAttendanceWithDateAndStudent/${date}/${student_id}`)).json();
        }

    }

    function selectAll() {
        // const listCheckbox = []
        // for (const i of checkBox.childNodes) {
        //     if (i.childNodes[0]['checked']) {
        //         listCheckbox.push(+i.childNodes[0].value);
        const checkboxes = document.getElementById("divId");
        for (const i of checkboxes.childNodes) {
            i.childNodes[1]['checked'] = true;
        }
        document.getElementById("buttonSendId").disabled = false;
    }

    async function sendDaysOfExcuse() {
        const allDaysToExcuse = document.getElementById("divId");
        const listCheckbox = []
        for (const i of allDaysToExcuse.childNodes) {
            if (i.childNodes[1]['checked']) {
                listCheckbox.push(i.childNodes[0].parentElement["id"]);
            }
        }
        await fetch(`/attendance/upDate/`, {
            method: 'PUT', body: JSON.stringify(listCheckbox),
            headers: {'Content-Type': 'application/json'}
        });
        await createLessonPlanTableWithAttendance();
        if(listCheckbox.length===allDaysToExcuse.childNodes.length){
            document.getElementById("buttonExcuseId").display='none';
             document.getElementById("selectAll").style.display = 'none';
             document.getElementById("divId").innerHTML='';
        }
        document.getElementById("buttonSendId").style.display = 'none';

    }

    async function init() {
        document.getElementById('date_id').valueAsDate = new Date();
        await createSelectOfChildrenForParent();
        await createLessonPlanTableWithAttendance();
    }


    init();


</script>

</html>