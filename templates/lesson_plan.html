<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Title</title>
    <script src="/static/menu.js"></script>
    <link rel="stylesheet" href="/static/main.style.css">
    <link rel="stylesheet" href="/static/class.style.css">
    <link rel="stylesheet"
          href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:opsz,wght,FILL,GRAD@20..48,100..700,0..1,-50..200"/>
    <link rel="stylesheet"
          href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:opsz,wght,FILL,GRAD@20..48,100..700,0..1,-50..200"/>
</head>
<body>
<div id="menu_id" class="menu"></div>
<script> createMenu(document.getElementById('menu_id'));</script>
<div>
    <br><label for="listOfClasses_id">wybierz przedmiot</label><br/>
    <select id="listOfClasses_id" name="listOfClasses"></select>
</div>
<button onclick="save()">zapisz</button>
<div class="flex-container" id="plannLessonId">
    <table id="table_id"></table>
</div>
</body>
<script>
    class LessonPlan {
        monday = {};
        tuesday = {};
        wednesday = {};
        thursday = {};
        friday = {};
    }

    const lessonPlan = new LessonPlan();

    async function save() {
        const clases = document.getElementById("listOfClasses_id").selectedOptions[0].value;
        await fetch(`/lessonPlan/save/${clases}`, {
            method: 'POST',
            body: JSON.stringify(lessonPlan),
            headers: {'Content-Type': 'application/json'}
        });
    }

    function createSelect(elements, optionInitializer) {
        const select = document.createElement("select");
        const emptyOption = document.createElement("option");
        emptyOption.innerHTML = '';
        select.add(emptyOption);
        for (const i of elements) {
            const option = document.createElement("option");
            optionInitializer(option, i);
            select.appendChild(option);
        }
        return select;
    }

    function isFull(data) {
        for (const i of data) {
            if (i['teacher'] || i['subject'] !== 0) {
                return 1
            }
        }
        return 0;
    }

    async function initLessonPlan(lessonPlan, hours) {
        const id_class = document.getElementById("listOfClasses_id").value;
        const dataOfBase = await (await fetch(`/lesson_plan/get_all_lesson_plan/${id_class}`)).json();
        if (isFull(dataOfBase)) {
            //id_clasy pobierz/wyslij endpoint i pobierz wszystko. zrob fora i sprawdz kazdy dzien i zrob slownik z niego
            for (const wiersz of dataOfBase) {
                if (wiersz['day'] === 'poniedziałek') {
                    lessonPlan.monday[wiersz['hour_id']] = {subject: wiersz['subject'], teacher: wiersz['teacher']}
                }
                if (wiersz['day'] === 'wtorek') {
                    lessonPlan.tuesday[wiersz['hour_id']] = {subject: wiersz['subject'], teacher: wiersz['teacher']}
                }
                if (wiersz['day'] === 'środa') {
                    lessonPlan.wednesday[wiersz['hour_id']] = {subject: wiersz['subject'], teacher: wiersz['teacher']}
                }
                if (wiersz['day'] === 'czwartek') {
                    lessonPlan.thursday[wiersz['hour_id']] = {subject: wiersz['subject'], teacher: wiersz['teacher']}
                }
                if (wiersz['day'] === 'piątek') {
                    lessonPlan.friday[wiersz['hour_id']] = {subject: wiersz['subject'], teacher: wiersz['teacher']}
                }
            }
        } else {
            hours.forEach(h => lessonPlan.monday[h.id] = {subject: null, teacher: null});
            hours.forEach(h => lessonPlan.tuesday[h.id] = {subject: null, teacher: null});
            hours.forEach(h => lessonPlan.wednesday[h.id] = {subject: null, teacher: null});
            hours.forEach(h => lessonPlan.thursday[h.id] = {subject: null, teacher: null});
            hours.forEach(h => lessonPlan.friday[h.id] = {subject: null, teacher: null});
        }
    }

    async function getTable() {
        document.getElementById("table_id").innerHTML = '';
        const hours = await (await fetch('/configuration_hours/getAllTime')).json();
        initLessonPlan(lessonPlan, hours);
        const tableOfLessonPlan = document.getElementById("table_id");
        const Hrow = tableOfLessonPlan.createTHead().insertRow();
        for (const i of ['godziny', 'poniedzialek', 'wtorek', 'sroda', 'czwartek', 'piatek']) {
            Hrow.insertCell().innerHTML = i;

        }
        const listOfTeacher = await (await fetch('/teacher/get_all_teacher')).json();
        const listOfSubject = await (await fetch('/subject/get_all')).json();
        const days = [null, lessonPlan.monday, lessonPlan.tuesday, lessonPlan.wednesday, lessonPlan.thursday, lessonPlan.friday]
        for (const j of hours) {
            const row = tableOfLessonPlan.insertRow();
            row.insertCell().innerHTML = `${j.from_hour}-${j.until_hours}`;
            for (let i = 1; i <= 5; i++) {
                const selectTeachers = createSelect(listOfTeacher,
                    (option, teacher) => {
                        option.innerHTML = `${teacher.name} ${teacher.last_name}`;
                        option.value = teacher.id;
                        if (teacher.id === days[i][j.id].teacher) {
                            option.selected = true;
                        }
                    })


                selectTeachers.onchange = () => days[i][j.id].teacher = selectTeachers.selectedOptions[0].value;
                const selectSubject = createSelect(
                    listOfSubject, (option, subject) => {
                        option.innerHTML = subject.name;
                        if(subject.name === days[i][j.id].subject){
                            option.selected = true;
                        }
                    }
                );
                selectSubject.onchange = () => days[i][j.id].subject = selectSubject.selectedOptions[0].value;
                row.insertCell().innerHTML = '';
                row.cells[i].appendChild(selectTeachers);
                row.cells[i].appendChild(selectSubject);
            }

        }
    }


    async function listOfClasses() {
        const name_classes = await (await fetch('/class/get_all')).json();
        const select_name_classes = document.getElementById("listOfClasses_id");
        for (const i of name_classes) {
            const option = document.createElement("option");
            option.value = i['id'];
            option.innerHTML = i['name_class'];
            select_name_classes.appendChild(option);
        }


    }

    async function init() {
        await listOfClasses();
        await getTable();
    }

    init();

</script>
</html>